name: Install Lovable Starter Kit

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Starter Kit version (branch/tag)'
        required: false
        default: 'main'
  # Auto-run when this workflow file is created/pushed
  push:
    paths:
      - '.github/workflows/install-starter-kit.yml'

jobs:
  install:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # Skip if triggered by bot (prevent infinite loop)
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          # Use input if provided (workflow_dispatch), otherwise default to 'main'
          VERSION="${{ github.event.inputs.version }}"
          echo "version=${VERSION:-main}" >> $GITHUB_OUTPUT

      - name: Download Starter Kit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          curl -L "https://github.com/Builera/lovable-starter-kit/archive/refs/heads/${VERSION}.zip" -o starter-kit.zip
          unzip starter-kit.zip
          mv "lovable-starter-kit-${VERSION}" starter-kit

      - name: Install OS files (skip existing)
        run: |
          # Function: copy file only if destination doesn't exist
          copy_if_not_exists() {
            src="$1"
            dest="$2"
            if [ ! -e "$dest" ]; then
              mkdir -p "$(dirname "$dest")"
              cp -r "$src" "$dest"
              echo "✅ Copied: $dest"
            else
              echo "⏭️ Skipped (exists): $dest"
            fi
          }
          
          # Copy directories (file-by-file to support merge)
          for dir in .lovable docs prompts examples scripts; do
            if [ -d "starter-kit/$dir" ]; then
              find "starter-kit/$dir" -type f | while read src_file; do
                dest_file="${src_file#starter-kit/}"
                copy_if_not_exists "$src_file" "$dest_file"
              done
            fi
          done
          
          # Copy root files (skip CHANGELOG_1.md, VERSION_1.md, README.md)
          for file in CHANGELOG.md QUICK-REFERENCE.md VERSION.md; do
            copy_if_not_exists "starter-kit/$file" "$file"
          done
          
          # Copy PR template
          mkdir -p .github
          copy_if_not_exists "starter-kit/.github/PULL_REQUEST_TEMPLATE.md" ".github/PULL_REQUEST_TEMPLATE.md"
          
          # Cleanup
          rm -rf starter-kit starter-kit.zip

      - name: Self-delete workflow file
        run: |
          rm -f .github/workflows/install-starter-kit.yml
          # Remove workflows dir if empty
          rmdir .github/workflows 2>/dev/null || true

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: Install Lovable Starter Kit

          AI Operating System installed from Builera/lovable-starter-kit
          - .lovable/ (rules, memory templates, boot-instruction)
          - docs/ (architecture, ADR templates, error templates)
          - prompts/ (workflow prompts)
          - examples/ (filled template examples)
          - scripts/ (validation scripts)
          
          Workflow self-deleted after install." || echo "No changes to commit"
          git push
