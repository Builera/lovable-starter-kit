name: Install Lovable Starter Kit

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to install (branch/tag)'
        required: false
        default: 'main'
  push:
    paths:
      - '.github/workflows/install-starter-kit.yml'

permissions:
  contents: write

jobs:
  install:
    # Skip on source repos to prevent self-deletion, and skip bot commits to prevent loops
    if: |
      github.actor != 'github-actions[bot]' &&
      github.repository != 'Builera/lovable-starter-kit' &&
      github.repository != 'Builera/lovable-starter-kit-dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version || 'main' }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=main" >> $GITHUB_OUTPUT
          fi

      - name: Fetch starter kit
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Installing Lovable Starter Kit version: $VERSION"

          # Download and extract starter kit
          curl -L "https://github.com/Builera/lovable-starter-kit/archive/refs/heads/${VERSION}.tar.gz" | tar xz

          # Move to temp directory for processing
          mv "lovable-starter-kit-${VERSION}" _starter_kit_temp

      - name: Copy files (skip existing)
        run: |
          # Directories to copy
          DIRS=".lovable docs prompts examples scripts"

          for dir in $DIRS; do
            if [ -d "_starter_kit_temp/$dir" ]; then
              if [ ! -d "$dir" ]; then
                echo "Creating directory: $dir"
                cp -r "_starter_kit_temp/$dir" "$dir"
              else
                echo "Directory exists, copying new files only: $dir"
                cd "_starter_kit_temp/$dir"
                find . -type f | while read file; do
                  target="../../$dir/$file"
                  if [ ! -f "$target" ]; then
                    mkdir -p "$(dirname "$target")"
                    cp "$file" "$target"
                    echo "  Copied: $dir/$file"
                  else
                    echo "  Skipped (exists): $dir/$file"
                  fi
                done
                cd ../..
              fi
            fi
          done
          
          # Root files to copy (skip if exist)
          # Note: RELEASES.md is the starter kit's changelog, NOT copied to user projects
          ROOT_FILES="CHANGELOG.md QUICK-REFERENCE.md VERSION.md"
          
          for file in $ROOT_FILES; do
            if [ -f "_starter_kit_temp/$file" ] && [ ! -f "$file" ]; then
              echo "Copying root file: $file"
              cp "_starter_kit_temp/$file" "$file"
            else
              echo "Skipped (exists or not in source): $file"
            fi
          done
          
          # Copy update workflow (persistent, not self-deleting)
          if [ -f "_starter_kit_temp/.github/workflows/update-starter-kit.yml" ]; then
            mkdir -p .github/workflows
            cp "_starter_kit_temp/.github/workflows/update-starter-kit.yml" ".github/workflows/update-starter-kit.yml"
            echo "Copied: .github/workflows/update-starter-kit.yml"
          fi

      - name: Generate template manifest
        run: |
          # Generate manifest with file hashes for smart merge updates
          if [ -f "_starter_kit_temp/scripts/generate-manifest.js" ]; then
            echo "Generating template manifest..."
            node _starter_kit_temp/scripts/generate-manifest.js
          else
            echo "Manifest generator not found, skipping..."
          fi

      - name: Cleanup temp
        run: rm -rf _starter_kit_temp

      - name: Self-delete workflow file
        run: |
          echo "Removing installer workflow (one-time use)..."
          rm -f .github/workflows/install-starter-kit.yml

          # Clean up empty .github/workflows if needed
          if [ -d ".github/workflows" ] && [ -z "$(ls -A .github/workflows)" ]; then
            rmdir .github/workflows
          fi
          if [ -d ".github" ] && [ -z "$(ls -A .github)" ]; then
            rmdir .github
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: install Lovable AI Project Operating System" -m "- Added .lovable/ directory with rules and memory bank" -m "- Added docs/ with architecture templates and ADRs" -m "- Added prompts/ with reusable AI prompts" -m "- Added examples/ with filled template references" -m "- Added scripts/ for validation" -m "- Installer workflow auto-removed after install" -m "Installed from: https://github.com/Builera/lovable-starter-kit"
            git push
          fi

      - name: Installation complete
        run: |
          echo "âœ… Lovable Starter Kit installed successfully!"
          echo ""
          echo "Next steps:"
          echo "1. Fill out .lovable/memory/projectbrief.md with your project details"
          echo "2. Review .lovable/rules.md and customize for your needs"
          echo "3. Check QUICK-REFERENCE.md for the workflow cheat sheet"
          echo ""
          echo "The installer workflow has been automatically removed."
